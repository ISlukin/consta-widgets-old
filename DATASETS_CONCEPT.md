# Описание концепции datasets и способов обработки raw data

## Описание основных элементов

![Схема работы с datasets](https://s.csssr.ru/U286BQJEP/20191015114204.png)

Dataset - представляет из себя конфиг с функциями-хелмперами и доп. метаинформацией, содержащий необходимую информацию о типе данных, о способах преобразования raw data (данных из API) в формат, с которым могут работать виджеты, и описание зависимостей, из которых и будет строиться запрос в graphql API

При добавлении виджета на дэшборд мы выбираем один из доступных ему датасетов. Доступность определяется по типу данных. Если widget и dataset имеют тип данных DataType.PieChart, то мы однозначно может определить какие datasets доступны виджету.

Как только конкретные датасеты для всех виджетов на дэшборде выбраны, мы можем получить всю необходимую информацию для формирования graphql запроса.

Делаем мы это путем анализа поля `deps` в датасетах. `deps` может иметь собственный формат (см. тип на схеме), а может иметь формат graphql схемы (можно поискать библиотеку для формирования запроса из формата в виде объекта).

После того, как запрос сформирован, мы выполняем его и получаем ответ с определенным набором данных:

```javascript
{
  productionControl: {
    productionSafaty: {
      someField: 10,
    }
  }
  otherFields: {}
}
```

Далее полученные данные мы пропускаем через `transformData` каждого датасета. В каждой функции `transformData` мы уже заранее знаем какие данные мы обрабатываем. Допустим, что определенный датасет ожидает получить `productionCotnrol` и как-то его преобразовать в конечный формат для виджета. Соотвественно, применяя `transformData` мы на выходе получаем те данные, которые уже будут использоваться непосредственно в виджете. Эти данные мы  по уникальнму для каждого отдельного виджета ключу кладем в store:

```javascript
{
  ...
  uniqWidgetKey: [{x: 0, y: 10}],
  ...
}
```

Потом dashboard получает весь объект с данными из store и раскладывает по видежтам данные, используя их уникальный ключ.

Таким образом в виджеты попадают уже преобразованные данные, и сами виджеты ничего не знают о том, как именно они преобразовываются.

В случае с graphql subscriptions мы просто на каждый push со стороны сервера будем прогонять шаг с транформацией и обновлять стор.
