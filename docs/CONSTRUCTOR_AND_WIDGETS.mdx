import { Meta } from '@storybook/addon-docs/blocks'

<Meta title="Документация/Конструктор и виджеты" />

# Конструктор и виджеты

Пакет gpn-dashboard-constructor состоит из 2 частей:

1. [**Библиотека готовых виджетов**](#библиотека-виджетов) — набор сложных компонентов, в большинстве своём это разного рода графики: линейный, столбчатый, пончик и т.д. Разработчики могут использовать их по отдельности в своих проектах.
2. [**Конструктор дашбордов**](#конструктор-дашбордов) — это инструмент, который позволяет из виджетов собирать целые дашборды. Конструктор стоит использовать в тех проектах, где пользователям нужна возможность формировать свои личные дашборды.

Использование виджетов в конструкторе накладывает на них некоторые ограничения, которые сказываются и на использовании этих виджетов по отдельности без конструктора. Поэтому сперва стоит узнать, что такое конструктор.

## Словарь

- **Дашборд** — экран с виджетами

- **Конфиг дашборда** — описание состава дашборда в формате JSON. В нём перечисленые виджеты, из которых состоит дашборд, указано их расположение и параметры.

- **Конструктор** — инструмент для редактирования и просмотра дашбордов

- **Виджет** — компонент, который может использоваться как внутри дашборда, так и отдельно сам по себе. Например, виджет линейного графика.

- **Миграция** — автоматизированный процесс обновления конфига дашборда на новую версию

## Конструктор дашбордов

### Юз-кейсы

Создание нового дашборда:

1. Пользователь создаёт новый пустой дашборд
1. Размещает на нём нужные графики
1. Настраивает внешний вид этих графиков
1. Указывает, откуда эти графики должны брать данные
1. Сохраняет результат
1. Открывает дашборд в режиме просмотра и наслаждается результатом

Внесение изменений в существующий дашборд:

1. Пользователь открывает существующий дашборд
1. Переходит в режим редактирования
1. Вносит нужные изменения (меняет расположение графиков, их параметры и источники данных, добавляет новые графики)
1. Сохраняет результат
1. Возвращается в режим просмотра

В [стори конструктора](?path=/story/dashboard-constructor--с-сохранением-состояния) можно поэкспериментировать с построением дашборда самостоятельно.

### Структура дашборда

Дашборд состоит из следующих блоков:

- Боксы
- Кастомные виджеты
- Обычные виджеты

#### Боксы

Боксы — это ячейки, в которые можно помещать виджеты. Нельзя положить виджет прямо на дашборд — сперва нужно разместить на дашборде бокс, а уже в него складывать виджеты.

Боксы на дашборде располагаются по сетке. Конфигурацию сетки можно задавать: количество строк, столбцов и отступы между ними. Например, [в стори конструктора](?path=/story/dashboard-constructor--с-сохранением-состояния) используется сетка из 12 колонок и 4 строк.

Внутри бокса сетки нет и все виджеты (и кастомные, и обычные) располагаются вертикально друг под другом.

[Стори бокса](?path=/story/dashboard-box--interactive)

#### Кастомные виджеты

Для огранизации пространства внутри бокса есть специальные виджеты, которые позволяют более гибко компоновать виджеты, а не просто располагать друг под другом.

- **Сетка** — позволяет создать сетку внутри бокса и располагать внутри неё виджеты. Эта сетка более гибкая, чем та, на которой располагаются боксы: можно добавлять любое количество строк/столбцов, а также менять соотношения их размеров. Сетка пригодится в тех случаях, когда виджеты в боксе нужно расположить горизонтально или таблично.

  [Стори сетки](?path=/story/dashboard-grid--interactive)

- **Переключатель** — позволяет показывать разное содержимое в зависимости от внешних данных. Переключатель содержит 2 или больше экранов, между которыми происходит переключение. Номер экрана, который надо показать, приходит в данных и может динамически меняться на усмотрение приложения, использующего конструктор.

  [Стори переключателя](?path=/story/dashboard-switch--interactive)

#### Виджеты

Обычные виджеты — это то, что лежит в разделе Widgets: разнообразные графики (линейный, столбчатый, радар), более простые элементы (текст, бэдж, виджет статы) и элементы управления (кнопка, календарь и т.д.).

У каждого из виджетов есть свой набор уникальных параметров внешнего вида. Во время редактирования дашборда пользователь конструктора через визуальный интерфейс может настроить эти параметры. Например, изменить размер бэджа или ориентацию графика.

### Данные для виджетов

Конструктор не работает с данными напрямую — он ожидает, что данные ему предоставит использующее его приложение. Поэтому ответственность за запрос необходимых данных и преобразование их в нужный виджетам формат лежит снаружи конструктора.

См. [«Описание концепции datasets и способов обработки raw data»](?path=/docs/документация-описание-концепции-datasets-и-способов-обработки-raw-data--page)

### Конфиг дашборда

Состояние дашборда сохраняется в один общий конфиг в JSON-формате. Конфиг содержит информацию о том, какие боксы находятся на дашборде, где они расположены, какие в них лежат виджеты и какие у этих виджетов параметры.

По мере работы над конструктором формат конфига может меняться: добавляются новые виджеты, меняются их параметры. При этом важно сохранить работоспособность дашбордов старой версии. Для этого служит механизм миграции, описанный [в соответствующем разделе](?path=/docs/документация-версионирование-дашбордов--page).

## Библиотека виджетов

Список готовых виджетов можно посмотреть в сторибуке в разделе Widgets.

### API виджета

Любой виджет принимает только 2 пропса: data и params. Это обусловлено тем, как виджеты используются внутри конструктора.

- **data** — это данные для отображения виджета. Например, координаты точек для графика или цифры для виджета статы. В большинстве случаев это та информация, которая поступает с бэкенда или вычисляется каким-то образом. Данные могут меняться динамически, если информация для графика обновляется на ходу.
- **params** — это настройки виджета, которые пользователь конструктора меняет под себя через визуальный интерфейс. Эти настройки не зависят от поступающих данных и влияют только на внешний вид виджета. Например, размер текста или ориентация графика. При добавлении новых параметров или изменении существующих, обязательно отразить это изменение в интерфейсе настроек. Предполагается, что динамически параметры меняться не могут, т.к. пользователь задаёт их в режиме редактирования, а потом уходит в режим просмотра.

### Требования к виджету

Каждый виджет представляет из себя изолированный самостоятельный компонент. Это накладывает на него следующие ограничения:

- Логика:
  - Виджет не должен знать о бизнес логике приложения, которое его использует. Задача виджета — отобразить переданную ему информацию (пропсы-данные) и оповестить о взаимодействиях (пропсы-колбэки).
  - Виджет не знает о существовании других виджетов. Если взаимодействие одного виджета должно повлиять на данные другого, эта логика реализуется в том приложении, которое подключает виджеты.
- Стили
  - У виджета должны быть чёткие границы без лишних отступов снаружи.
  - Виджет должен задавать ресеты, цвета и размеры своих внутренних частей и не рассчитывать на то, что снаружи сделаны ресеты или заданы какие-то общие стили (например, базовый цвет шрифта).
  - Стилизация виджета полностью опирается на компоненты и переменные из [Дизайн-системы](?path=/docs/документация-дизайн--page) и подчиняется темам.

### Виджет vs Обычный компонент

В сторибуке пакета есть не только раздел Widgets, но и раздел Components. Это внутренние компоненты, которые внутри пакета могут использоваться в том числе и для реализации виджетов. Но в отличие от виджетов эти компоненты не экспортируются для использования сторонними разработчиками и соответственно не имеют контракта на своё API. Стори для них существуют для упрощения разработки и тестирования и могут быть в какой-то момент удалены.

### Виджет vs Компонент из ui-кита

Некоторые виджеты берут за основу компонент из ui-кита и оборачивают его таким образом, чтобы этот компонент можно было использовать в конструкторе. Примеры таких виджетов: кнопка (ButtonWidget), чекбокс (CheckboxWidget), радио (ChoiceGroupWidget), текст (TextWidget) и бэдж (BadgeWidget).

Некоторые из них добавляют ui-компонентам дополнительную функциональность. Например, виджет текста позволяет задать тултип, который будет появляться по ховеру на иконку справа от текста. Аналогично бэдж и кнопка позволяют показать тултип при ховере на них самих.

Если вы используете пакет как библиотеку виджетов, советуем ui-компоненты брать напрямую из ui-кита. Тогда между вашим проектом и ui-китом не будет лишней прослойки в виде этого пакета. Из данного пакета стоит использовать только сложные компоненты, которых нет в ui-ките.
