import { Meta } from '@storybook/addon-docs/blocks'

<Meta title="Документация/Миграции" />

# Миграции

В случае, когда меняется формат данных дашборда (например, изменяется название какого-то поля или добавляется новое), нужно завести новую версию дашборда и добавить миграцию. Для каждой версии дашборда есть своё представление структуры его конфига. Это значит что при повышении/понижении версии конструктора может измениться и версия дашборда, а вместе с ней и структура конфига, который описывает дашборд. Для того, чтобы руками не отслеживать изменения, которые могли сломать конфиг вашего дашборда, нам и нужна миграция. **Миграция** — механизм организации структуры конфига дашборда. Она сверяет текущую версию вашего дашборда и актуальную, если они разнятся, то она прогоняет через себя конфиг, чтобы обновить его до актуальной версии.

# Механизм работы миграции
Механизм миграции берёт вашу текущую версию дашборда и сравнивает с актуальной. После этого он прогоняет конфигурацию дашборда через все миграции, которые были написано между версиями. Поскольку кол-во версий может разниться больше чем на одну, то миграции выполняются в строгом порядке их добавления, потому что все изменения закреплены за конкретной версией дашборда. Механизм миграции работает в 2 стороны:
- Вверх — когда актуальная версия дашборда выше вашей текущей версии
- Вниз — когда актуальная версия дашборда ниже вашей текущей версии

## Примеры конфига после выполнения миграции

### Пример, когда в обе стороны присутствуют изменения
Предположим, что у виджета `LinearChart` в новой версии поменялся параметр, который определяет ориентацию виджета, `isVertical` на `isHorizontal`.

### Вверх
Изначально у нас в конфиге есть такой кусок описания виджета:
```js
params: {
  ...,
  isVertical: true,
}
```

В новой версии конструктора этого параметра больше нет и нам нужно его заменить на новый. Для этого конфиг дашборда прогоняется через миграцию и получается на выходе обновленный конфиг:
```js
params: {
  ...,
  isHorizontal: false,
}
```

### Вниз
Изначально у нас в конфиге есть такой кусок описания виджета:
```js
params: {
  ...,
  isHorizontal: false,
}
```

В старой версии конструктора этого параметра не было, а был `isVertical`. Поэтому для корректной работы дашборда, нам нужно прогнать его конфиг через миграцию. На выходе мы получим обновленный конфиг, который будет корректно работать:
```js
params: {
  ...,
  isVertical: true,
}
```

### Пример, когда миграция выполняется только в одну сторону
Предположим, что у виджета `Text` добавил новый размер текста. Раньше был набор только из `s`, `m`, `l`, а теперь есть возможность выбрать `xl`

### Вверх
В данном случае миграция не будет изменить конфиг, потому что новый размер никак не аффектит старую конфигурацию.

### Вниз
Изначально у нас в конфиге есть такой кусок описания виджета:
```js
params: {
  ...,
  size: 'xl',
}
```

В старой версии конструктора у параметра `size` нет варианта `xl`, поэтому нам нужно подправить конфигурацию так, чтобы это не сильно аффектило работоспособность дашборда. Поэтому мы заменяем размер `xl` на максимально похожий.
```js
params: {
  ...,
  size: 'l',
}
```

## Типизация

Процесс обновления типов:

1. Создать новую миграцию, [подробнее в главе "Создание новой миграции"](#создание-новой-миграции);
1. Добавить новые типы в namespace. Если добавляются какие-то новые типы, влияющие на тип стэйта дашборда, нужно добавить их в нэймспэйс этого дашборда, а потом реэкспортнуть в `src/dashboard/types.ts` (по аналогии с реэкспортом `Settings` или `MarginSize`).
1. Типы, которые описывают параметры для виджетов, нужно править/добавлять в папке [widget-params](https://github.com/CSSSR/gpn-dashboard-constructor/tree/master/src/migrations/current/widget-params)

За исключением папки миграций и [src/dashboard/types.ts](https://github.com/CSSSR/gpn-dashboard-constructor/blob/master/src/dashboard/types.ts) нигде не должно быть прямых импортов типов из отдельных версий дашборда. Все импорты типов, связанные со стэйтом дашборда, должны быть из файла [src/dashboard/types.ts](https://github.com/CSSSR/gpn-dashboard-constructor/blob/master/src/dashboard/types.ts), а импорты типов, связанные с параметрами виджетов, должны быть из файла [src/dashboard/widget-params.ts](https://github.com/CSSSR/gpn-dashboard-constructor/blob/master/src/dashboard/widget-params.ts).

### Создание новой миграции
Чтобы создать новую миграцию, нужно:

1. Запустить скрипт с помощью команд `yarn migration:create` или `npm run migration:create`;
1. Обновить новую миграцию в файле [src/migrations/current/index.ts](https://github.com/CSSSR/gpn-dashboard-constructor/blob/master/src/migrations/current/index.ts):
    * добавить/изменить необходимые типы;
    * обновить метод `up` (функция повышения версии с предыдущей);
    * обновить метод `down` (функция понижения версии до предыдущей).
1. Обновить тесты для новой миграции в файле [src/migrations/current/__tests__/index.ts](https://github.com/CSSSR/gpn-dashboard-constructor/blob/master/src/migrations/current/__tests__/index.ts).

### Причины
Изменения, после которых **нужно** писать миграцию:
- Изменения, касающиеся параметров виджета:
    - Переименовался параметр
    - Параметр стал обязательным для заполнения
    - Изменился набор вариантов для существующего параметра
    - Добавился новый параметр (при миграции вверх ничего не надо делать, а при миграции вниз удалить его)
    - Удалился параметр (при миграции вверх надо его удалить, а при миграции вниз вернуть)
- Изменения, касающиеся конфига кастомного виджета
- Изменения, касающиеся конфига дашборда
- Удалился виджет (при миграции вверх нужно удалить его из конфигов)
- Добавился новый виджет (при миграции вниз нужно его удалить)

Изменения, после которых **не нужно** писать миграцию:
- Изменилось дефолтное значение параметра
- У виджета изменился формат данных
- Изменился визуальный ряд: цвет/размер шрифта/размер отступов

## Интерфейс
Поведение отличается в зависимости от режима (просмотр / редактирование) и версии переданного дашборда.

* Если версия переданного дашборда выше текущей поддерживаемой, то отображается ошибка. Это значит, что дашборд был создан на клиенте более новой версии. На старой версии клиента мы такой дашборд открыть не можем.
* Если версия переданного дашборда ниже:
    * В режиме просмотра дашборд обновляется до последней версии без предупреждения и отображается пользователю. `onChange` в таком случае не должен дёргаться, т.е. на бэке версия дашборда остаётся старой и обновляется на клиенте при каждом открытии.
    * В режиме редактирования отображается предупреждение с предложением обновить версию. По нажатию на кнопку «Обновить» дёрнется `onChange` с обновлённой версией, благодаря чему изменение будет сохранено на бэке.

Дополнительно в режиме редактирования можно понизить версию — для этого нужно в левом меню выбрать версию ниже и согласиться с предупреждением.
