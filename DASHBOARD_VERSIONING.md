# Версионирование дашбордов

В случае, когда меняется формат данных дашборда (например, изменяется название какого-то поля или добавляется новое), нужно завести новую версию дашборда и добавить миграцию.

## Типизация
Процесс обновления типов:
1. Завести новую папку для версии: `src/dashboard/migration/migrations/dashboardX`, где X — это номер версии. Версии нумеруются по порядку, начиная с 0.
1. Добавить новые типы в namespace `DashboardX` (в качестве основы скопировать типы предыдущей версии). Если добавляются какие-то новые типы, влияющие на тип стэйта дашборда, нужно добавить их в нэймспэйс этого дашборда, а потом реэкспортнуть в `src/dashboard/types.ts` (по аналогии с реэкспортом `Settings` или `MarginSize`)
1. Новый тип стэйта нужно добавить к юниону `AnyDashboardStateVersion` (`src/dashboard/migration/migrations/index.ts`)
1. Заменить актуальный namespace на новый `import Dashboard = DashboardX` (`src/dashboard/types.ts`)
1. Обновить номер текущей версии `SUPPORTED_DASHBOARD_VERSION` (`src/dashboard/index.tsx`)

За исключением папки миграций и `src/dashboard/types.ts` нигде не должно быть прямых импортов типов из отдельных версий дашборда. Все импорты типов, связанные со стэйтом дашборда, должны быть из файла `src/dashboard/types.ts`.

## Миграции
Для новой версии нужно написать миграции вверх и вниз:
* Добавить миграцию в файл с типами `migrations/dashboardX/index.ts`
    * up — функция повышения версии с предыдущей
    * down — функция понижения версии до предыдущей
* Добавить тесты для миграции в оба направления
* Импортнуть и добавить миграцию в список всех миграций `src/dashboard/migration/migrations/index.ts`

## Интерфейс
Поведение отличается в зависимости от режима (просмотр / редактирование) и версии переданного дашборда. 

* Если версия переданного дашборда выше текущей поддерживаемой, то отображается ошибка. Это значит, что дашборд был создан на клиенте более новой версии. На старой версии клиента мы такой дашборд открыть не можем.
* Если версия переданного дашборда ниже:
    * В режиме просмотря дашборд обновляется до последней версии без предупреждения и отображается пользователю. `onChange` в таком случае не должен дёргаться, т.е. на бэке версия дашборда остаётся старой и обновляется на клиенте при каждом открытии.
    * В режиме редактирования отображается предупреждение с предложением обновить версию. По нажатию на кнопку «Обновить» дёрнется `onChange` с обновлённой версией, благодаря чему изменение будет сохранено на бэке.
    
Дополнительно в режиме редактирования можно понизить версию — для этого нужно в левом меню выбрать версию ниже и согласиться с предупреждением.
    
